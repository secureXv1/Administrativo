import{_ as j,m as b,s as B,c as i,a as t,e as g,f as A,z as T,A as z,F as U,j as O,x as K,i as m,t as o,I as V,o as u,k as q}from"./index-3j6Ei78Q.js";const W={class:"min-h-screen bg-slate-50"},F={class:"max-w-6xl mx-auto px-2 sm:px-4 py-6 space-y-4"},M={class:"card"},X={class:"card-body grid grid-cols-1 sm:grid-cols-6 gap-3"},J=["value"],Q={class:"sm:col-span-6 flex gap-2"},Y={class:"card"},Z={class:"card-body p-0 overflow-x-auto"},ee={class:"table w-full"},te={class:"align-top text-slate-700"},ne={class:"align-top"},se={class:"mr-1"},ae={class:"align-top"},oe={class:"text-slate-900"},le={key:0,class:"mt-1"},re={class:"inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 ring-1 ring-slate-200"},ie={key:0,class:"opacity-70"},ue={key:1,class:"mt-1 flex flex-wrap gap-1.5"},de={key:0,class:"inline-flex text-[11px] px-2 py-0.5 rounded-full bg-slate-50 text-slate-600 ring-1 ring-slate-200"},ce={key:1,class:"inline-flex text-[11px] px-2 py-0.5 rounded-full bg-slate-50 text-slate-600 ring-1 ring-slate-200"},ge={key:2,class:"inline-flex text-[11px] px-2 py-0.5 rounded-full bg-slate-50 text-slate-600 ring-1 ring-slate-200"},pe={key:2,class:"text-xs text-slate-500 mt-1"},_e={class:"align-top"},be={class:"text-slate-900"},ve={class:"text-xs text-slate-500"},Ee={class:"align-top"},fe={class:"align-top truncate max-w-[220px]"},Ce={class:"align-top text-right"},Ae=["onClick"],me={key:0},xe={class:"p-3 flex items-center justify-between text-sm text-slate-600"},$e={class:"flex items-center gap-2"},Re=["disabled"],Te=["disabled"],he={key:0,class:"fixed inset-0 bg-black/40 flex items-center justify-center p-4"},ye={class:"bg-white rounded-xl shadow-xl max-w-2xl w-full p-4"},Ie={class:"flex items-center justify-between mb-2"},Ue={class:"font-semibold"},Oe={class:"text-xs bg-slate-50 rounded p-3 overflow-auto max-h-[60vh]"},Ne={__name:"AdminAuditLog",setup(Se){const x=[{value:"",label:"Todas",icon:"•"},{value:"LOGIN",label:"Inicio de sesión",icon:"🔑"},{value:"LOGOUT",label:"Cierre de sesión",icon:"⎋"},{value:"ACCOUNT_LOCK",label:"Bloqueo temporal",icon:"⏳"},{value:"ACCOUNT_HARD_LOCK",label:"Bloqueo",icon:"🔒"},{value:"ACCOUNT_UNLOCK",label:"Desbloqueo de cuenta",icon:"🔓"},{value:"REPORT_CREATE",label:"Registro de reporte",icon:"📝"},{value:"REPORT_UPDATE",label:"Edición de reporte",icon:"✏️"},{value:"EXCEL_DOWNLOAD",label:"Descarga Excel",icon:"📊"},{value:"USER_CREATE",label:"Creación de usuario",icon:"👤➕"},{value:"USER_PASSWORD_CHANGE",label:"Cambio de contraseña",icon:"🔒"},{value:"USER_ROLE_CHANGE",label:"Cambio de rol",icon:"🎛"},{value:"AGENT_CREATE",label:"Creación de agente",icon:"🧑‍✈️➕"},{value:"AGENT_UPDATE",label:"Edición de agente",icon:"🧑‍✈️✏"},{value:"GROUP_CREATE",label:"Creación de grupo",icon:"🧩"},{value:"UNIT_CREATE",label:"Creación de unidad",icon:"🏷️"},{value:"AGENT_ASSIGN",label:"Asignación de agente",icon:"📥"},{value:"AGENT_RELEASE",label:"Liberación de agente",icon:"📤"}],N=x.filter(s=>s.value).map(s=>s.value),d=b({from:"",to:"",action:"",username:""}),f=b([]),C=b(0),p=b(1),h=b(50),$=b(!1),v=b(null);function R(s){return x.find(e=>e.value===s)||x[0]}function S(s){switch(s){case"LOGIN":return"badge-green";case"LOGOUT":return"badge-slate";case"ACCOUNT_LOCK":return"badge-amber";case"ACCOUNT_HARD_LOCK":return"badge-red";case"ACCOUNT_UNLOCK":return"badge-lime";case"REPORT_CREATE":return"badge-blue";case"REPORT_UPDATE":return"badge-amber";case"EXCEL_DOWNLOAD":return"badge-emerald";case"USER_CREATE":return"badge-purple";case"USER_PASSWORD_CHANGE":return"badge-orange";case"USER_ROLE_CHANGE":return"badge-violet";case"AGENT_CREATE":return"badge-teal";case"AGENT_UPDATE":return"badge-cyan";case"GROUP_CREATE":return"badge-indigo";case"UNIT_CREATE":return"badge-indigo";case"AGENT_ASSIGN":return"badge-emerald";case"AGENT_RELEASE":return"badge-red";default:return"badge-slate"}}function D(s){return R(s).icon}function L(s){return!s&&s!==0?"—":(typeof s=="number"?new Date(s):new Date(String(s))).toLocaleString()}function w(s){try{return JSON.stringify(s||{},null,2)}catch{return String(s)}}function G(){d.value={from:"",to:"",action:"",username:""},E(1)}function k(s){v.value=s}function P(s){try{return typeof s=="string"?JSON.parse(s):s||null}catch{return null}}function r(s){return P(s?.details)}function H(s){const e=r(s)||{},n=s.username?`@${s.username}`:"usuario";switch(s.action){case"LOGIN":return`Inicio de sesión de ${n}`;case"LOGOUT":return`Cierre de sesión de ${n}`;case"ACCOUNT_LOCK":{const a=e.minutes?`${e.minutes} min`:e.lock_until?"hasta "+e.lock_until:"";return`Bloqueo temporal de ${e.targetUserId?`ID ${e.targetUserId}`:e.username?"@"+e.username:"cuenta"}${a?" · "+a:""}${e.reason?" · "+e.reason:""}`}case"ACCOUNT_HARD_LOCK":return`Bloqueo de ${e.targetUserId?`ID ${e.targetUserId}`:e.username?"@"+e.username:"cuenta"}${e.reason?" · "+e.reason:""}`;case"ACCOUNT_UNLOCK":return`Desbloqueo de ${e.username?`@${e.username}`:e.targetUserId?`ID ${e.targetUserId}`:"cuenta"}`;case"REPORT_CREATE":{const a=e.reportId?`#${e.reportId}`:"",l=e.reportDate||"",c=e.groupId!=null?`grupo ${e.groupId}`:"",_=e.unitId!=null?`unidad ${e.unitId}`:"",I=Array.isArray(e.agents)?e.agents.length:e.agentsCount??"";return`Registro de reporte ${[a,l,c,_,I?`${I} agentes`:""].filter(Boolean).join(" · ")}`}case"REPORT_UPDATE":{const a=e.reportId?`#${e.reportId}`:"",l=e.agentCode||e.code||"",c=e.state||e?.changes?.state,_=`Actualizó reporte ${a}${l?` para agente ${l}`:""}`;return c?`${_} · estado: ${c}`:_}case"EXCEL_DOWNLOAD":{const a=e.date||"",l=e.groupId!=null?`grupo ${e.groupId}`:"",c=e.unitId!=null?`unidad ${e.unitId}`:"",_=[a,l,c].filter(Boolean);return`Descargó Excel${_.length?" · "+_.join(" · "):""}`}case"USER_CREATE":return`Creó usuario ${e.username?"@"+e.username:"nuevo usuario"}${e.role?" · rol "+e.role:""}`;case"USER_PASSWORD_CHANGE":return`Cambio de contraseña de usuario${e.by?` (${e.by})`:""}`;case"USER_ROLE_CHANGE":return`Cambio de rol de usuario${e.oldRole||e.newRole?`: ${e.oldRole||"—"} → ${e.newRole||"—"}`:""}`;case"AGENT_CREATE":return`Creó agente ${e.code||"sin código"}${e.category?" · "+e.category:""}`;case"AGENT_UPDATE":{const a=e?.changes?.code||e.code,l=e?.changes?Object.keys(e.changes).filter(c=>c!=="code"):[];return`Editó agente ${a||""}${l.length?` · campos: ${l.join(", ")}`:""}`}case"GROUP_CREATE":return`Creó grupo ${e.code||"nuevo"}`;case"UNIT_CREATE":return`Creó unidad ${e.name||"nueva"}${e.groupId!=null?" · grupo "+e.groupId:""}`;case"AGENT_ASSIGN":{const a=e.agentCode?` ${e.agentCode}`:"",l=e.toUnitId!=null?`unidad ${e.toUnitId}`:"unidad ?",c=e.mode?` (${e.mode})`:"";return`Asignó agente${a} a ${l}${c}`}case"AGENT_RELEASE":{const a=e.agentCode?` ${e.agentCode}`:"",l=e.fromUnitId!=null?`unidad ${e.fromUnitId}`:"unidad ?",c=e.mode?` (${e.mode})`:"";return`Liberó agente${a} de ${l}${c}`}default:return"Evento"}}function y(s){const e=r(s)||{};if(s.action==="REPORT_UPDATE"){const n=[];return e.municipalityId&&n.push(`municipio ${e.municipalityId}`),e.novelty_start&&n.push(`inicio ${e.novelty_start}`),e.novelty_end&&n.push(`fin ${e.novelty_end}`),e.novelty_description&&n.push(`"${String(e.novelty_description).slice(0,50)}${String(e.novelty_description).length>50?"…":""}"`),n.join(" · ")||null}if(s.action==="AGENT_ASSIGN"||s.action==="AGENT_RELEASE"){const n=[];return e.fromGroupId!=null&&n.push(`grupo: ${e.fromGroupId} → ${e.toGroupId??"—"}`),(e.fromUnitId!=null||e.toUnitId!=null)&&n.push(`unidad: ${e.fromUnitId??"—"} → ${e.toUnitId??"—"}`),n.length?n.join(" · "):null}return null}async function E(s=1){$.value=!0,p.value=s;try{const e={page:p.value,pageSize:h.value};Object.entries(d.value).forEach(([a,l])=>{l!==""&&l!=null&&(e[a]=l)});const{data:n}=await V.get("/admin/audit",{params:e});f.value=n.items||[],C.value=n.total||0}catch(e){console.error("AUDIT LIST ERROR",e),f.value=[],C.value=0}finally{$.value=!1}}return B(()=>{const s=new Date,e=new Date(s);e.setDate(e.getDate()-6),d.value.from=e.toISOString().slice(0,10),d.value.to=s.toISOString().slice(0,10),E(1)}),(s,e)=>(u(),i("div",W,[e[18]||(e[18]=t("header",{class:"sticky top-0 z-10 backdrop-blur bg-white/70 border-b border-slate-200"},[t("div",{class:"max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"},[t("h1",{class:"text-slate-900 font-semibold text-lg sm:text-2xl"},"Log de eventos"),t("div",{class:"text-sm text-slate-600"},"Solo superadmin")])],-1)),t("main",F,[t("div",M,[t("div",X,[t("div",null,[e[8]||(e[8]=t("label",{class:"label"},"Desde",-1)),A(t("input",{type:"date","onUpdate:modelValue":e[0]||(e[0]=n=>d.value.from=n),class:"input"},null,512),[[T,d.value.from]])]),t("div",null,[e[9]||(e[9]=t("label",{class:"label"},"Hasta",-1)),A(t("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=n=>d.value.to=n),class:"input"},null,512),[[T,d.value.to]])]),t("div",null,[e[11]||(e[11]=t("label",{class:"label"},"Acción",-1)),A(t("select",{"onUpdate:modelValue":e[2]||(e[2]=n=>d.value.action=n),class:"input"},[e[10]||(e[10]=t("option",{value:""},"Todas",-1)),(u(!0),i(U,null,O(K(N),n=>(u(),i("option",{key:n,value:n},o(n),9,J))),128))],512),[[z,d.value.action]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"label"},"Usuario",-1)),A(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=n=>d.value.username=n),class:"input",placeholder:"Usuario a buscar"},null,512),[[T,d.value.username]])]),t("div",Q,[t("button",{class:"btn-primary",onClick:e[4]||(e[4]=n=>E(1))},"Aplicar filtros"),t("button",{class:"btn-ghost",onClick:G},"Limpiar")])])]),t("div",Y,[t("div",Z,[t("table",ee,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",{class:"whitespace-nowrap"},"Fecha/Hora"),t("th",null,"Acción"),t("th",null,"Resumen"),t("th",null,"Usuario"),t("th",null,"IP"),t("th",{class:"whitespace-nowrap"},"User Agent"),t("th")])],-1)),t("tbody",null,[(u(!0),i(U,null,O(f.value,n=>(u(),i("tr",{key:n.id},[t("td",te,o(L(n.created_at_ts??n.created_at)),1),t("td",ne,[t("span",{class:q(["badge",S(n.action)])},[t("span",se,o(D(n.action)),1),m(" "+o(R(n.action).label),1)],2)]),t("td",ae,[t("div",oe,o(H(n)),1),r(n)?.agentCode?(u(),i("div",le,[t("span",re,[e[13]||(e[13]=t("svg",{class:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{d:"M10 10a4 4 0 100-8 4 4 0 000 8zm-7 8a7 7 0 1114 0H3z"})],-1)),m(" Agente: "+o(r(n).agentCode)+" ",1),r(n).agentCategory?(u(),i("span",ie,"· "+o(r(n).agentCategory),1)):g("",!0)])])):g("",!0),r(n)?.reportDate||r(n)?.groupId||r(n)?.unitId?(u(),i("div",ue,[r(n).reportDate?(u(),i("span",de," Fecha: "+o(r(n).reportDate),1)):g("",!0),r(n).groupId!=null?(u(),i("span",ce," Grupo: "+o(r(n).groupId),1)):g("",!0),r(n).unitId!=null?(u(),i("span",ge," Unidad: "+o(r(n).unitId),1)):g("",!0)])):g("",!0),y(n)?(u(),i("div",pe,o(y(n)),1)):g("",!0)]),t("td",_e,[t("div",be,o(n.username||"—"),1),t("div",ve,"Rol: "+o(n.userRole||"—"),1)]),t("td",Ee,o(n.ip||"—"),1),t("td",fe,o(n.user_agent||"—"),1),t("td",Ce,[t("button",{class:"btn-ghost",onClick:a=>k(n)},"Ver",8,Ae)])]))),128)),!$.value&&!f.value.length?(u(),i("tr",me,e[14]||(e[14]=[t("td",{colspan:"7",class:"text-center py-6 text-slate-500"},"Sin resultados",-1)]))):g("",!0)])])]),t("div",xe,[t("div",null,[e[16]||(e[16]=m("Total: ",-1)),t("b",null,o(C.value),1)]),t("div",$e,[t("button",{class:"btn-ghost",disabled:p.value<=1,onClick:e[5]||(e[5]=n=>E(p.value-1))},"«",8,Re),t("div",null,[e[17]||(e[17]=m("Página ",-1)),t("b",null,o(p.value),1)]),t("button",{class:"btn-ghost",disabled:p.value*h.value>=C.value,onClick:e[6]||(e[6]=n=>E(p.value+1))},"»",8,Te)])])])]),v.value?(u(),i("div",he,[t("div",ye,[t("div",Ie,[t("div",Ue,"Detalles ("+o(R(v.value.action).label)+")",1),t("button",{class:"btn-ghost",onClick:e[7]||(e[7]=n=>v.value=null)},"Cerrar")]),t("pre",Oe,o(w(r(v.value))),1)])])):g("",!0)]))}},we=j(Ne,[["__scopeId","data-v-7b84241e"]]);export{we as default};
